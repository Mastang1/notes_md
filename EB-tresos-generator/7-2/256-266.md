这是文档 **第 256-266 页** 的翻译内容。

这一部分完成了 **基于模板的代码生成器** 的剩余高级功能（如排除文件、错误处理），并详细介绍了 **公共生成器 API (Public Generator API)**、**NG 生成器 API (NG Generator API)**（包括对 JET 和 Ant 的支持）以及 **EPC 文件生成器 API**。

---

### 7.2.11. 

从生成中排除文件 (Excluding files from the generation) 

可以使用一个特殊的标记将文件从生成过程中排除。当代码生成器遇到 `[!SKIPFILE!]` 标记时，它会标记该文件。当应用程序处理到这个被标记的文件时，根本不会生成它（尽管它会被完全解析，并且会发出错误和警告）。

`[!SKIPFILE!]` 标记有两种形式：

1. `[!SKIPFILE!]`
2. `[!SKIPFILE "<XPath-Expression>"!]`

在第一种形式中，文件在任何情况下都不会被生成。
在第二种形式中，仅当 XPath 表达式的计算结果为 `false` 时，才会生成文件（即表达式为 `true` 时跳过）。

> **⚠️ 警告**
> **如果 XPath 表达式的计算结果为字符串值，只有 'true'（不区分大小写）被解释为真**
> 这与其他 XPath 的使用情况相反，通常除了空字符串以外的任何字符串都为真。

一个代码模板可以有多个 `[!SKIPFILE!]` 语句，在这种情况下，最后一个语句会覆盖所有其他语句。

### 7.2.12. 

断言、错误和警告 (Asserts, errors and warnings) 

为了在生成过程中检查配置并向用户发布错误和警告，代码生成器支持四种结构：断言 (asserts)、错误 (errors)、警告 (warnings) 和信息消息 (info messages)。通过这些结构提交的消息通过回调接口传递给应用程序。错误和断言会立即停止生成过程，而警告和信息消息仅向应用程序提交一条消息。

错误、警告和信息消息都使用相同的语法：

* `[!ERROR "<Message>"!]` 或
```
[!ERROR!]
    <Message>
[!ENDERROR!]

```


* `[!WARNING "<Message>"!]` ... `[!ENDWARNING!]`
* `[!INFO "<Message>"!]` ... `[!ENDINFO!]`

每种结构都有两种形式：

1. **直接形式**：直接在起始标记中包含消息。不需要结束标记。如果消息不以问号开头，则解释为纯文本。如果以问号开头，则消息的其余部分将被评估为 XPath 表达式。
2. **块形式**：比第一种更强大。在第二种形式中，消息体可以包含迄今为止描述的所有结构（如 `[!IF!]`, `[!LOOP!]` 等）。

**断言 (Assert)** 是错误语句的一种特殊形式。它包含一个 XPath 表达式。只有当此表达式计算结果为 `false` 时，才会打印消息并结束生成运行。

* `[!ASSERT "<XPath expression>","<Message>"!]`
* `[!ASSERT "<XPath expression>"!] <Message> [!ENDASSERT!]`

---

### 7.3. 

公共生成器 API (Public Generator API) 

要为模块注册一个公共 API 生成器，必须完成两个步骤：

1. 注册扩展点 `dreisoft.tresos.generator.api.plugin.generator`。
2. 实现公共 API 生成器 Java 类。

#### 7.3.1. 注册公共 API 生成器 (Registering A Public API Generator)

* 打开插件的 `plugin.xml` 并切换到 **Extensions** 标签页。
* 点击 **Add** 并选择 `dreisoft.tresos.generator.api.plugin.generator` 扩展点。
* 在右侧输入以下值：
* **Generator-ID**：此生成器的标识符。
* **Module-ID**：此生成器应注册到的模块。
> **💡 提示：** 留空 Module-ID 可用于模块无关的生成器。在这种情况下，生成器将独立于模块运行，并为每个模块运行。注意，模块无关的生成器仅允许在 `pre` 和 `post` 步骤中使用。


* **Step**：此生成器应运行的步骤。步骤可以是 `pre`、`post` 或 `default`（留空则为 default）。
* **ConfigClass**：此生成器的配置类。生成器只能访问其配置类或配置过程中较早的配置类的参数。配置类必须是可编辑的才能运行生成器。


* 点击 `class*:` 或 **Browse...** 创建或查找已实现的生成器类。

#### 7.3.2. 实现公共 API 生成器 (Implementing a Public API Generator)

公共 API 生成器必须实现接口 `dreisoft.tresos.generator.api.generator.ICodeGenerator` 以及以下三个方法：

1. `public void generate( CodeGeneratorContext context )`
2. `public String getDefaultMode()`
3. `public String[] getAvailableModes( ParameterSet parameters )`

**示例代码：**

```java
/* 返回生成器可以调用的模式 */
public String[] getAvailableModes( ParameterSet parameters ) {
    return new String[]{MODE_GENERATE};
    // 如果还想用此生成器进行验证，可以使用：
    // return new String[]{MODE_GENERATE, MODE_VERIFY};
}

/* 返回生成器的默认模式 - 在此例中为 "generate" */
public String getDefaultMode() {
    return MODE_GENERATE;
}

```

---

### 7.4. 

NG 生成器 API (NG Generator API) 

#### 7.4.1. 目的 (Purpose)

自 EB tresos Studio 2008.b 版本起，提供了一个新的生成器框架。所谓的**新一代 (NG) 生成器 API** 带来了许多新功能，同时也支持经典的基于模板的和外部的代码生成器。当然，现有的生成器框架仍然有效，无需切换到新 API。

#### 7.4.2. JET 支持 (JET Support)

NG 生成器 API 包含对基于 **JET (Java Emitter Templates)** 模板的生成器的支持。JET 语言是一种类似于 JSP 的脚本语言，它使用带有 Java 代码的脚本片段在固定文本之间生成动态输出。

在执行 JET 模板之前，必须由 JET 构建器处理，生成 Java 源文件。此 Java 源文件必须先编译为 Java 类，然后才能执行。
JET 生成器的输出通常产生一个文件。脚本片段中的 Java 表达式没有任何限制，因此 JET 生成器可以包含比经典模板代码生成器更强大的逻辑。

**JET 文件代码片段示例：**

```jsp
<%@ jet package="xyz.jet.generated" class="TheNumbersGame" %>
<% for( int i = 1; i <= 10; i++ ) { %>
This is round <%=Integer.toString( i )%>.
<% } %>

```

#### 7.4.3. 独立 JET 编译器 (Standalone JET compiler)

如上所述，JET 模板在使用前必须先生成 Java 源文件。为此，EB tresos Studio 提供了一个独立的 JET 编译器应用程序。您可以通过位于安装目录 `bin` 文件夹中的 `compile_jet.bat` 文件运行它。

#### 7.4.4. C 数据结构生成器 (C Data Structures Generator - CDS)

C 数据结构 (CDS) 生成器是一个全新的代码生成框架。它提供了将 Java 对象生成为 C 语言的类型和变量定义的功能。
CDS 生成器主要用于将配置值生成为模块运行时代码所需的 **C 结构体 (C-structs)**。通过将配置值与逻辑分离，可以在编译运行时代码后替换配置值。因此，此功能旨在用于**链接时 (link-time)** 和 **构建后 (post-build)** 配置。

支持以下功能：

* 基本类型、指针、结构体和数组
* Typedefs
* 内置和自定义类型的变量初始化
* 空指针和函数指针支持
* 编译器抽象 (Compiler abstraction)
* 内存抽象 (Memory abstraction)
* 每个变量和成员的注释
* Volatile 修饰符
* 结构体中的条件成员

#### 7.4.5. Apache Ant 支持 (Apache Ant support)

NG 生成器 API 的主要目标之一是集成流行的构建工具 **Apache Ant**。实际上，NG 生成器 API 总是需要一个 Ant 构建文件来执行。
NG 生成器 API 使用现有的生成器扩展点。因此，注册的生成器类必须始终是 `dreisoft.tresos.generator.ng.api.NGGenerator`。
构建文件通过生成器扩展点处的 `NGGenerator` 类的嵌套 `parameter` 标签指定。

**示例注册：**

```xml
<generator id="NGGeneratorAPITestGenerator"
           moduleId="NGGeneratorAPITest_TS"
           class="dreisoft.tresos.generator.ng.api.NGGenerator">
    <parameter name="buildfile" value="resources/generator_build.xml" />
</generator>

```

**提供的 Ant 任务 (Tasks)：**
EB tresos Studio 为每种类型的生成器提供了 Ant 任务。

* `ng.property`: 允许通过查询 DataModel 设置 Ant 属性。
* `ng.setgeneratorvar`: 允许从 build.xml 中设置上下文变量。
* `ng.getgeneratorvar`: 允许获取上下文变量并将其设置为 Ant 属性。
* `ng.tmplgen`: 运行**基于模板**的代码生成器。
* `ng.extgen`: 运行**外部**代码生成器。
* `ng.jetgen`: 运行一个已经编译为 Java 类的 JET 模板。
* `ng.jetgen.src`: 编译并运行以源代码形式交付的 JET 模板。
* `ng.javagen`: 运行一个 Java 生成器（必须实现 `IJavaGenTemplate` 接口）。
* `ng.javagen.src`: 编译并运行以源代码形式交付的 Java 生成器。

#### 7.4.6. 源码交付 (Source delivery)

如上所示，任务 `ng.javagen.src` 和 `ng.jetgen.src` 允许以源代码形式交付生成器，而不是已经编译为类。对于 Java 生成器，它是实现接口的 Java 源文件；对于 JET 生成器，它是 JET 模板。这两个任务都会在执行之前先编译指定的源文件。

---

### 7.5. 

EPC 文件生成器 API (EPC File Generator API) 

#### 7.5.1. 目的 (Purpose)

EPC 文件生成器对所有使用**外部生成器**的开发人员非常有用。要调用外部生成器，通常需要 `.epc` 文件。EB tresos Studio 使用 `.xdm` 文件存储配置。为了能够结合 EB tresos Studio 使用外部生成器，提供了一个额外的生成器：EPC 文件生成器。

#### 7.5.2. 生成 EPC 文件 (Generating EPC files)

EPC 文件生成器易于使用：

1. 在提供外部生成器的所有模块的生成器扩展点中使用 EPC 文件生成器。
2. 从 GUI 或命令行（基于项目模式或旧模式）以 `generate` 模式运行生成器，以在输出目录中创建所需的 `.epc` 文件。

**在 plugin.xml 中注册示例：**

```xml
<extension point="dreisoft.tresos.launcher2.plugin.generator"
           id="EPCGenerator" name="EPC Generator">
    <generator moduleId="Lin_TS_T17D12M1I1R0"
               id="Lin_TS_T17D12M1I1R0GeneratorId"
               class="dreisoft.tresos.autosar2.generator.EPCFileGenerator">
        <parameter name="cfgFilePath" value="output"/>
        <parameter name="generateAllModules" value="false"/>
        <parameter name="generateIntoOneFile" value="false"/>
        <parameter name="generateModuleTypes" value="Rte, Os, EcuM" />
        <parameter name="contentType" value="asc:2.1"/>
    </generator>
</extension>

```

**可用参数：**

* `cfgFilePath`: 创建 `.epc` 文件的路径（相对于输出目录）。
* `generateAllModules`: (Boolean) 是否导出项目中的所有模块配置。默认为 "true"。
* `generateModuleTypes`: 指定要导出的模块类型列表（逗号分隔）。仅当 `generateAllModules` 为 "false" 时使用。
* `generateIntoOneFile`: (Boolean) 指定是否将生成的模块配置存储在一个单独的文件中，还是每个模块配置存储在单独的 `<Module-Type>.epc` 文件中。默认为 "false"。
* `contentType`: 指定生成文件的内容类型（例如 `asc:2.0`）。
* `allVariants`: (Boolean) 指定是否导出所有变体（包括变体信息）。默认为 `false`。如果设置为 `true` 且项目有当前选定的 Selectable 变体，则导出包含所有变体和变体点信息的完整配置。