这是文档 **第 114-124 页** 的翻译内容。

这一部分完成了 **5.3 节（如何创建新模块）** 的剩余内容，包括模块配置、注册编辑器和生成器、定义模块版本以及如何将模块安装到 Studio 中。随后进入了 **5.4 节**，详细介绍了如何将模块从旧版 AUTOSAR（2.x）迁移到较新版本（3.x, 4.x）。

---

### 5.3.7.3.2. 模块配置 (Module configuration)

`data` 标签定义了如何创建新实例的模块配置。
通过 `manager` 标签可以选择管理模块配置的 Java 类。其 `class` 属性必须设置为 `dreisoft.tresos.autosar2.resourcehandling.AutosarConfigManager`。

`schemaNode` 标签选择用于创建模块配置的模块定义。`path` 属性必须包含一个指向已注册 Schema 文件中模块定义的 XPath 或 ASPath。

**5.3.7.3.2.1. 模块配置的包结构 (Package structure of the module configuration)**
默认情况下，新创建的模块配置将被放置在一个与模块配置同名的包（package）中。例如，"Can" 模块配置将包含在名为 "Can" 的包中。因此，其 ASPath 将是 `/Can/Can`。

要更改此默认行为，您可以向 `manager` 标签添加一个 `parameter` 子标签。该子标签的 `name` 属性必须设置为 `"package"`，`value` 属性必须包含所需的包名称。

使用此标签，还可以定义模块配置应包含在子包中，方法是使用斜杠分隔包名称，如下例所示：

```xml
<manager class="dreisoft.tresos.autosar2.resourcehandling.AutosarConfigManager">
  <parameter name="package" value="parentPkg/subPackage"/>
</manager>

```

使用上面的示例，模块配置将包含在包 "subPackage" 中，而该包本身包含在包 "parentPkg" 中。

### 5.3.7.3.3. 注册编辑器 (Registering editors)

`editor` 标签允许注册供用户编辑模块配置的编辑器。EB tresos Studio 提供了一个通用配置编辑器的实现，可以通过此标签进行注册。

通用配置编辑器的注册形式如下：

```xml
<editor id="AnyUniqueId" label="AnyLabel" tooltip="AnyTooltip">
  <class class="dreisoft.tresos.launcher2.editor.GenericConfigEditor">
    <parameter name="schema" value="ASPath to your MODULE-DEF"/>
  </class>
</editor>

```

必须根据具体模块编辑以下属性：

* **id**：必须是唯一的 ID，用于标识编辑器。
* **label**：在 GUI 中显示的编辑器标签。
* **tooltip**：在 GUI 中显示的编辑器工具提示。

通用配置编辑器要求通过 `parameter` 标签设置以下参数：

* **schema**：用于创建模块配置的模块定义的路径。该值必须与 `data` 标签中给出的路径匹配。

### 5.3.7.3.4. 代码示例 (Code sample)

以下示例显示了一个完整的配置扩展：

```xml
<extension point="dreisoft.tresos.launcher2.plugin.configuration" id="AnyUniqueId" name="AnyName">
  <configuration moduleId="YourModuleId">
    <schema>
      <manager class="dreisoft.tresos.autosar2.resourcehandling.AutosarSchemaManager"/>
      <resource value="RelativePathToYourVsMD" type="xdm"/>
    </schema>
    <data>
      <manager class="dreisoft.tresos.autosar2.resourcehandling.AutosarConfigManager"/>
      <schemaNode path="ASPath to your MODULE-DEF"/>
    </data>
    <editor id="AnyUniqueId" label="AnyLabel" tooltip="AnyTooltip">
      <class class="dreisoft.tresos.launcher2.editor.GenericConfigEditor">
        <parameter name="schema" value="ASPath to your MODULE-DEF"/>
        <parameter name="title" value="AnyTitle"/>
      </class>
    </editor>
  </configuration>
</extension>

```

### 5.3.7.4. dreisoft.tresos.launcher2.plugin.generator (生成器)

通过 `generator` 扩展点，可以为模块注册代码生成器。一个模块可以有任意数量的代码生成器。`generator` 扩展点提供 `generator` 标签作为其唯一标签。

`generator` 标签支持以下属性：

* **id**：可以通过此属性给生成器一个唯一的 ID。
* **moduleId**：用于注册模块的模块扩展的 ID。
* **class**：实现代码生成器的 Java 类。
* **step** (可选)：属性 `step` 允许选择调用生成器的代码生成阶段。代码生成分三个阶段运行：`pre`（前处理）、`default`（默认）、`post`（后处理），按此顺序运行。通过值 `pre` 和 `post`，可以将生成器调度到前处理或后处理步骤中。

基于模板的代码生成器在 Java 类 `dreisoft.tresos.launcher2.generator.TemplateBasedCodeGenerator` 中实现。通过 `parameter` 标签，可以自定义基于模板的代码生成器。可以使用以下参数：

* **templates**：选择相对于模块插件根目录的路径，在该路径下可以找到代码模板。

```xml
<extension point="dreisoft.tresos.launcher2.plugin.generator"
           id="StandardModule_TS16D4M2I0R0GenExt"
           name="Module PlugIn TemplateGenerator">
  <generator class="dreisoft.tresos.launcher2.generator.TemplateBasedCodeGenerator"
             id="AnyUniqueId"
             moduleId="YourModuleId">
    <parameter name="templates" value="RelativeTemplatePath"/>
  </generator>
</extension>

```

### 5.3.7.5. 模块版本 (Module versions)

在 `plugin.xml` 中，可以为每个模块指定软件版本、规范版本和发布版本。此信息显示在“EB tresos Details”对话框中，该对话框显示所有已安装的模块。

**要打开“EB tresos Details”对话框：**

1. 从 **Help** 菜单中选择 **EB tresos Details...**。
2. 切换到 **Module Registry** 选项卡。

所有已安装模块的软件版本、规范版本和发布版本（以及其他信息）都将显示出来。

或者，用户可以在模块配置 UI 右侧的 **Details** 区域查看版本信息，例如在“新建项目向导”或“模块配置”对话框中。要打开 Details 区域，用户必须在 Available Modules 树或模块配置 UI 的 Module Configurations 表中选择模块。

每个版本都可以选择性地包含前缀和/或后缀。这只是非正式信息，不会以任何方式进行评估。尽管如此，此信息会呈现给用户，因此应该是不言自明的。

#### 5.3.7.5.1. 软件版本 (Software version)

提供此模块所基于的软件版本。例如，这可能是包含的代码生成器的软件版本，或者是处理生成代码的软件的版本。这也可以用于在未来版本中定义模块依赖关系。

#### 5.3.7.5.2. 规范版本 (Specification version)

提供此模块所基于的规范版本。这可以用于在未来版本中定义模块依赖关系。

#### 5.3.7.5.3. 发布版本 (Release version)

提供此模块所基于的发布版本。用户必须为每个新创建的项目定义一个“发布版本”，这将限制该项目可用的模块。为此，仅使用主版本号和次版本号。

### 5.3.8. 代码模板 (Code templates)

如果在 `plugin.xml` 中未更改，代码生成器将在插件的 `generate` 目录下搜索代码模板。一个好的做法是在生成路径中创建一个以插件名称命名的目录，因为可能有多个模块具有相同的输出路径。

### 5.3.9. 将模块添加到 EB tresos Studio

要将插件安装到 EB tresos Studio，请将整个目录复制到 EB tresos Studio 安装目录的 `plugins` 目录中。

由于 Eclipse 中的一个错误，必须删除 EB tresos Studio 安装目录 `configuration` 下名为 `org.eclipse.*` 的所有目录。

> **注意：** `org.eclipse.*` 目录包含有关已安装插件的缓存信息。不删除它们可能会导致一些未定义的效果。

重新启动 EB tresos Studio 后，新插件将可用。

如果您购买了与 EB tresos Studio 配套的 EB tresos AutoCore，您还可以将插件与用户构建环境（User Build environment）集成。您可以在 EB tresos AutoCore 文档中找到如何执行此操作的说明：*EB tresos AutoCore documentation / EB tresos AutoCore user's guide / Build environment*。

---

### 5.4. 如何将您的模块从一个 AUTOSAR 版本迁移到另一个版本

#### 5.4.1. 如何将 AUTOSAR 2.x 模块迁移到 3.x

将 AUTOSAR 2.x 模块转换为 AUTOSAR 3.x 必须按以下顺序完成：

1. 使用 `legacy vsmd` 命令行命令从 AUTOSAR 3.x StMD 文件创建 VSMD XDM 文件。
2. 将现有 AUTOSAR 2.x 参数定义中的所有供应商特定更改合并到新创建的 AUTOSAR 3.x 供应商特定参数定义文件中。
3. 使用 `legacy vsmdcheck` 命令行命令确保新参数定义符合 AUTOSAR 3.x。

> **注意：** 不要将现有的 XDM 文件直接转换为 AUTOSAR 格式，因为这样会丢失所有 XDM 特有的功能。

以下小节介绍了 AUTOSAR 2.1 和 AUTOSAR 3.0 之间的更改，在将参数定义切换到 AUTOSAR 3.x 时必须考虑这些更改。有关更多信息，请参阅 AUTOSAR 文档。

**5.4.1.1. Choices (选择容器)**
自 AUTOSAR 3.0 起，XDM 文件中的 Choice 类型为 `IDENTIFIABLE`（在以前的 AUTOSAR 中，它们的类型为 `CHOICE`）：

* **错误：** `<v:chc name="CanTrcvAccess" type="CHOICE">`
* **正确：** `<v:chc name="CanTrcvAccess" type="IDENTIFIABLE">`

这在合并旧的和新的 vsmd XDM 文件时特别重要。VSMD 检查器会将无效的 `v:chc` 标签标记为错误。

> **注意：** 由于 Choice 现在在 ECU 配置描述中表示为 `IDENTIFIABLE` 元素，因此配置中 Choice 下的所有 AUTOSAR 路径都必须调整。这意味着，即使 Schema 本身在 AUTOSAR 2.1 和 AUTOSAR 3.x 之间没有变化，现有的配置如果不更改也不能使用。这也适用于预配置和推荐配置。

**5.4.1.2. Configuration variant (配置变体)**
AUTOSAR 3.0 引入了配置变体。通过此新功能，一个模块参数定义可用于描述编译时（Compile Time）、链接时（Link Time）和构建后（Post Build）模块实现。这允许用户在编辑模块配置时选择模块的实际变体。

VSMD 描述了模块实际支持哪些配置变体。因此，模块开发人员负责决定模块将支持哪些变体。
AUTOSAR StMD 通常定义了每个模块的所有变体。VSMD 模块定义的创建者必须决定实际支持哪些变体，并从 VSMD 文件中删除多余的变体。为此，必须调整变量 `IMPLEMENTATION_CONFIG_VARIANT`：

```xml
<v:var name="IMPLEMENTATION_CONFIG_VARIANT" type="ENUMERATION">
  <a:a name="LABEL" value="Config Variant"/>
  <a:da name="DEFAULT" value="VariantPreCompile"/>
  <a:da name="RANGE">
    <a:v>VariantPreCompile</a:v>
    <a:v>VariantLink</a:v>
    <a:v>VariantPostBuild</a:v>
    <a:v>VariantPostBuildSelectable</a:v>
  </a:da>
</v:var>

```

每个配置参数指定其在每个配置变体中的配置类（Configuration Class）。对于从 StMD 接管的所有参数，必须调整这些列表。对于所有供应商特定的参数，必须添加相应的映射。配置类映射在 XDM 中的形式如下：

```xml
<v:var name="AdcHwUnitId" type="INTEGER">
  <a:a name="IMPLEMENTATIONCONFIGCLASS" type="IMPLEMENTATIONCONFIGCLASS">
    <icc:v class="PreCompile">VariantPreCompile</icc:v>
    <icc:v class="Link">VariantPostBuild</icc:v>
    <icc:v class="PostBuild">VariantPostBuild</icc:v>
    <icc:v class="PostBuildSelectable">VariantPostBuildSelectable</icc:v>
  </a:a>
</v:var>

```

**5.4.1.3. ADMIN-DATA**
自 AUTOSAR 3.0 版本以来，`ADMIN-DATA` 必须像这样添加到 `MODULE-DEF` 下：

```xml
<d:chc name="CanIf" type="AR-ELEMENT" value="MODULE-DEF">
  <v:ctr type="MODULE-DEF">
    <a:a name="ADMIN-DATA" type="ADMIN-DATA">
      </a:a>
  </v:ctr>
</d:chc>

```

#### 5.4.2. 如何将 AUTOSAR 模块迁移到 AUTOSAR 版本 4.x

要将模块迁移到 AUTOSAR 4.x，请执行以下任务：

1. 在您的 XDM 文件中，在 xml 标签 `<v:ctr type="MODULE-DEF">` 内添加行 `<a:a name="RELEASE" value="asc:4.0"/>`。
```xml
<d:ctr type="AUTOSAR" factory="autosar" ... >
  <d:lst type="TOP-LEVEL-PACKAGES">
    <d:ctr name="AUTOSAR" type="AR-PACKAGE">
      <d:lst type="ELEMENTS">
        <d:chc name="Adc" type="AR-ELEMENT" value="MODULE-DEF">
          <v:ctr type="MODULE-DEF">
            <a:a name="RELEASE" value="asc:4.0"/>
            ```


```


2. AUTOSAR 4.0 格式重新定义了大多数 XML 标签。EB tresos Studio 在 XDM 文件中透明地处理此标签重命名，因此您不必手动更改 XDM 文件。

---

**（第 114-124 页翻译结束）**

接下来的内容（5.5 节起）将介绍：

* **5.5 如何使用 crypto 命令对模块进行签名**（用于发布模块）。
* **5.6 模块转换器 API (Module Transformer API)**：用于在不同版本或目标之间转换现有模块配置。
* **5.7 变体处理 (Variant handling)**：包括 Post-build loadable 支持。

**需要继续翻译吗？**